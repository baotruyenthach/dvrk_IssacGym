# Testing grasps on a rectangular prism (full example)
In this example, we will take a 3D model of a rectangular prism and evaluate candidate grasps on it according to different grasps tests. There are four different grasp tests: pickup, reorient, linear acceleration, and angular acceleration. The details of each of these tests can be found in our paper on [our website](https://sites.google.com/nvidia.com/deformable-object-grasping/). The input files used in this example are in `examples/rectangle`

# Mesh processing
In order to load an object model into IsaacGym, we must
1. Generate a tetrahedral mesh from a 3D model
2. Convert that mesh into the IsaacGym-specific `.tet` format

### Pre-processing the surface mesh
In our example, we have a surface mesh of a rectangular prism named `rectangle.stl`. We recommend using [fTetWild](https://github.com/wildmeshing/fTetWild) to perform this meshing. Other surface mesh formats compatible with fTetWild include the `.off/.obj/.ply` formats.

The density of the vertices in the starting surface mesh will directly impact the density of the volume mesh that will be generated by fTetWild. Before using fTetWild, the surface mesh density can be increased/decreased by resampling/clustering in software such as MeshLab or Blender. 

The finite element method also performs best when there are minimal geometric curvature discontinuities. It is suggested that any sharp corners or edges on the object  model be filleted prior to converting it into a mesh.

<img src="images/meshlab.png" width="500"/>
<img src="images/denser_meshlab.png" width="500"/>

Visualizing `rectangle.stl` in MeshLab, in which the surface mesh density can be changed (lower density (top), higher density (bottom)).

### Generate tetrahedral mesh from surface mesh
Then, run fTetwild on the surface mesh. Make sure that the output file name is in the `.mesh` format. Example usage:
`./FloatTetwild_bin -o ~/meshes/rectangle.mesh -i ~/meshes/rectangle.stl`. If successful, a tetrahedral mesh of the input surface mesh should be generated.

### Convert `.mesh` to `.tet`
The script `mesh_to_tet.py` in the root directory converts the `rectangle.mesh` file into `rectangle.tet`. Define the `mesh_file` and `tet_output` variables in the script with the paths to the input `.mesh` and output `.tet` file respectively, the run the script with `python3 mesh_to_tet.py`. 

# Grasp generation
Generate grasp poses of the Franka Panda hand for the object. The grasp poses are stored in a h5 called `rectangle_grasps.h5`. These poses were generated automatically using the [graspsampling](https://gitlab-master.nvidia.com/ceppner/graspsampling-py) grasp sampling code, specifically with the antipodal sampler scheme. Custom grasps can also be selected, though the h5 file containing the grasp poses must have the following structure:
* Contain a dataset named `'poses'` containing a numpy array of shape (num_grasp_poses, 7)
* Each grasp pose is a represented as an array of length 7 in the form `[px, py, pz, w, x, y, z]` where `px, py, pz` is the gripper position and `w, x, y, z` are the quaternion components.

# Running grasp evaluations (examples)
### Pickup
Example command to evaluate pickup of the prism under grasp 31 (as ordered in `rectangle_grasps.h5`)
`run_grasp_evaluation --object=rectangle --grasp_ind=31 --youngs=2e5 --density=1000 --mode=pickup --write`

<img src="images/pickup0.png" width="500"/>

Gripper initialized at the desired pose

<img src="images/pickup1.png" width="500"/>

Gripper closes and squeezes the object

<img src="images/pickup2.png" width="500"/>

Support platform lowers once desired squeezing force is reqched


### Reorient
Example command to evaluate pickup of the prism under grasp 3 about vector 4. 
`python3 run_grasp_evaluation.py --object=rectangle --youngs=2e5 --density=1000 --ori_start=4 --ori_end=4 --mode=reorient --write --grasp_ind=3`

<img src="images/reorient0.png" width="500"/>

Object is being picked up

<img src="images/reorient1.png" width="500"/>

Gripper slowly rotates the object about vector 4

<img src="images/reorient4.png" width="500"/>

Test finishes when pi radians is covered 

### Linear acceleration
Example command to evaluate linear instability of the prism under grasp 31 along vector 0
`python3 run_grasp_evaluation.py --object=rectangle --youngs=2e4 --density=1000 --ori_start=0 --ori_end=0 --mode=shake --grasp_ind=31`

<img src="images/shake0.png" width="500"/>

Object is picked up off the support plane

<img src="images/shake1.png" width="500"/>

Gripper accelerates along vector 0 at a constant jerk

<img src="images/shake2.png" width="500"/>

Tests finishes when contact is lost (as is _about_ to happen here), or when the maximum linear acceleration is reached.

### Angular acceleration
Example command to evaluate angular instability of the prism under grasp 31 about vector 4
`python3 run_grasp_evaluation.py --object=rectangle --youngs=2e4 --density=1000 --ori_start=4 --ori_end=4 --mode=twist --grasp_ind=31`

<img src="images/pickup0.png" width="500"/>

Object is picked up off the support plane

<img src="images/twist1.png" width="500"/>

Gripper angularly accelerates about vector 4 at a constant jerk

<img src="images/twist2.png" width="500"/>

Tests finishes when contact is lost (as is the case here), or when the maximum angular acceleration is reached.

#### Parallelizing simulations
For the reorient, linear acceleration, and angular acceleration tests, evaluations over multiple vectors can be performed in parallel. For example, running 
``python3 run_grasp_evaluation.py --object=rectangle --youngs=2e5 --density=1000 --ori_start=4 --ori_end=6 --mode=reorient --write --grasp_ind=3` will generate 3 simulation environments for vectors 4, 5, and 6. 

<img src="images/parallel_envs.png" width="500"/>

### Expected output
If the experiments were run with the `--write` flag, then H5 result files should have been written to your `RESULTS_DIR` folder (see README for more details of H5 dataset structure). You should see that the dataset is populated based on the grasp index that was run. For example, 
For example, we can examine the output from the reorient test that was run with `--grasp_ind=3` and `--ori_start=4` in the Python console. 

Running the following 
```
>>> import h5py
>>> f = h5py.File('<reorient_result_file_name>.h5', 'r')
>>> f['reorientation_meshes'][3,4]
```


should return a non-zero (4, 364, 3) array where the first dimension indexes the meshes recorded at a rotation angle of {pi/4, pi/2, 3*pi/4, pi}, the second dimension is the index of the mesh node, and the third dimension is the 3D (xyz) position of each mesh node. 

